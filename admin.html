<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Productos - Vacano Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/global.css">
    <style>
        /* Estilos básicos para el panel de administración */
        body { font-family: 'Montserrat', sans-serif; background-color: var(--color-fondo-principal); color: var(--color-texto-principal); line-height: 1.6; }
        .container { max-width: 1200px; margin: 30px auto; padding: 25px; background-color: var(--color-fondo-secundario); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        h1, h2 { color: var(--color-primario); text-align: center; margin-bottom: 30px; font-weight: 700; }
        section { margin-bottom: 40px; padding: 20px; border-radius: 10px; background-color: var(--color-fondo-tarjeta); box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;}
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--color-texto-principal); }
        input[type="text"], input[type="number"], textarea {
            width: calc(100% - 24px); padding: 12px; border: 1px solid var(--color-borde); border-radius: 6px;
            background-color: var(--color-fondo-input); color: var(--color-texto-principal);
            font-size: 1em;
        }
        textarea { min-height: 90px; resize: vertical; }
        input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
        button {
            background-color: var(--color-primario); color: white; padding: 12px 25px; border: none; border-radius: 30px;
            cursor: pointer; font-size: 1.05em; font-weight: bold; transition: background-color 0.3s ease, transform 0.2s ease;
            margin-right: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button:hover { background-color: var(--color-primario-oscuro); transform: translateY(-2px); }
        button.delete-btn { background-color: #dc3545; }
        button.delete-btn:hover { background-color: #c82333; }
        button.edit-btn { background-color: #ffc107; color: #333; }
        button.edit-btn:hover { background-color: #e0a800; }
        #saveProductBtn, #clearFormBtn { grid-column: span 2; width: auto; margin: 15px auto 0; display: block;}
        #clearFormBtn { background-color: #6c757d; }
        #clearFormBtn:hover { background-color: #5a6268; }

        .product-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 30px; }
        .product-item {
            border: 1px solid var(--color-borde); padding: 20px; border-radius: 10px;
            background-color: var(--color-fondo-tarjeta); box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .product-item h3 { margin-top: 0; color: var(--color-texto-principal); font-size: 1.4em; }
        .product-item p { margin-bottom: 8px; color: var(--color-texto-secundario); font-size: 0.95em; }
        .product-item .actions { margin-top: 20px; text-align: right; }
        .product-item img { max-width: 120px; height: auto; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--color-borde); }
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .auth-box {
            background-color: var(--color-fondo-secundario); padding: 40px; border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3); text-align: center;
            max-width: 400px; width: 90%;
        }
        .auth-box h2 { margin-bottom: 25px; color: var(--color-primario); font-size: 2.2em; }
        .auth-box input { margin-bottom: 20px; width: calc(100% - 24px); }
        .auth-box button { width: 100%; margin-right: 0; }
        .auth-error { color: #dc3545; margin-top: 15px; font-weight: bold; }

        /* Media Queries para Responsividad */
        @media (max-width: 768px) {
            form { grid-template-columns: 1fr; }
            #saveProductBtn, #clearFormBtn { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-box">
            <h2>Acceso al Panel de Administración</h2>
            <input type="password" id="adminPassword" placeholder="Ingresa la clave de administrador" required>
            <button id="loginBtn">Ingresar</button>
            <p id="authError" class="auth-error" style="display: none;">Clave incorrecta. Intenta de nuevo.</p>
        </div>
    </div>

    <div class="container" id="adminContent" style="display: none;">
        <h1>Administración de Productos</h1>

        <section id="product-form-section">
            <h2>Crear/Editar Producto</h2>
            <form id="productForm">
                <div>
                    <label for="productId">ID del Producto (único):</label>
                    <input type="text" id="productId" required>
                </div>
                <div>
                    <label for="productName">Nombre:</label>
                    <input type="text" id="productName" required>
                </div>
                <div>
                    <label for="productPrice">Precio:</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div>
                    <label for="productOriginalPrice">Precio Original (si es oferta):</label>
                    <input type="number" id="productOriginalPrice" step="0.01">
                </div>
                <div>
                    <label for="productDiscount">Descuento (%):</label>
                    <input type="number" id="productDiscount">
                </div>
                <div>
                    <label for="productDescription">Descripción Larga:</label>
                    <textarea id="productDescription"></textarea>
                </div>
                <div>
                    <label for="productShortDescription">Descripción Corta:</label>
                    <input type="text" id="productShortDescription">
                </div>
                <div>
                    <label for="productImages">URLs de Imágenes (separadas por comas):</label>
                    <textarea id="productImages" placeholder="Ej: url1.jpg, url2.png"></textarea>
                </div>
                <div>
                    <label for="productStock">Stock:</label>
                    <input type="number" id="productStock" min="0" value="0">
                </div>
                <div>
                    <label for="productCategory">Categoría:</label>
                    <input type="text" id="productCategory">
                </div>
                <div>
                    <input type="checkbox" id="productFeatured">
                    <label for="productFeatured">Destacado</label>
                </div>
                <div>
                    <input type="checkbox" id="productOnOffer">
                    <label for="productOnOffer">En Oferta</label>
                </div>
                <button type="submit" id="saveProductBtn">Guardar Producto</button>
                <button type="button" id="clearFormBtn">Limpiar Formulario</button>
            </form>
        </section>

        <section id="product-list-section">
            <h2>Lista de Productos</h2>
            <div class="product-list" id="productList">
                <p style="text-align: center; color: var(--color-texto-secundario);">Cargando productos...</p>
            </div>
        </section>
    </div>

    <script>
        const API_BASE_URL = '/api'; // Apunta a las Netlify Functions

        // Elementos de Autenticación
        const authOverlay = document.getElementById('authOverlay');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const authError = document.getElementById('authError');
        const adminContent = document.getElementById('adminContent');

        // Elementos del Formulario de Producto
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productShortDescriptionInput = document.getElementById('productShortDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productOriginalPriceInput = document.getElementById('productOriginalPrice');
        const productDiscountInput = document.getElementById('productDiscount');
        const productImagesInput = document.getElementById('productImages');
        const productStockInput = document.getElementById('productStock');
        const productCategoryInput = document.getElementById('productCategory');
        const productFeaturedInput = document.getElementById('productFeatured');
        const productOnOfferInput = document.getElementById('productOnOffer');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const productListDiv = document.getElementById('productList');

        let editingProductId = null; // Para saber si estamos editando o creando
        let productsData = []; // Almacena los productos cargados para facilitar la edición

        // *** IMPORTANTE: LA CLAVE DEBE SER LA MISMA QUE EN TU VARIABLE DE ENTORNO NETLIFY ADMIN_SECRET_KEY ***
        const ADMIN_FRONTEND_KEY = 'miClaveUltraSecretaDeVacano2025!'; // <-- ¡CAMBIA ESTO!


        // --- Lógica de Autenticación ---
        loginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_FRONTEND_KEY) {
                authOverlay.style.display = 'none';
                adminContent.style.display = 'block';
                fetchProducts(); // Cargar productos una vez autenticado
            } else {
                authError.style.display = 'block';
            }
        });

        adminPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });


        // --- Funciones para interactuar con las Netlify Functions ---

        async function authenticatedFetch(url, options = {}) {
            const token = ADMIN_FRONTEND_KEY;
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            return fetch(url, { ...options, headers });
        }

        async function fetchProducts() {
            try {
                // get-products no requiere autenticación en la función de Netlify, pero podrías añadirla
                // si quisieras que el listado de productos fuera solo para admins.
                const response = await fetch(`${API_BASE_URL}/get-products`); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                productsData = await response.json(); // Guarda los datos para edición
                renderProductList(productsData);
            } catch (error) {
                console.error('Error fetching products:', error);
                productListDiv.innerHTML = '<p style="color: red; text-align: center;">Error al cargar productos. Intenta de nuevo más tarde.</p>';
            }
        }

        async function createProduct(productData) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/create-product`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                alert('Producto creado exitosamente!');
                clearForm();
                fetchProducts(); // Recargar la lista
            } catch (error) {
                console.error('Error creating product:', error);
                alert('Error al crear producto: ' + error.message);
            }
        }

        async function updateProduct(productId, productData) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/update-product?id=${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                alert('Producto actualizado exitosamente!');
                clearForm();
                fetchProducts();
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Error al actualizar producto: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm(`¿Estás seguro de que quieres eliminar el producto con ID: ${productId}?`)) {
                return;
            }
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/delete-product?id=${productId}`, {
                    method: 'DELETE',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                alert('Producto eliminado exitosamente!');
                fetchProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error al eliminar producto: ' + error.message);
            }
        }

        // --- Lógica del Formulario y Renderizado ---

        function renderProductList(products) {
            productListDiv.innerHTML = '';
            if (products.length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; color: var(--color-texto-secundario);">No hay productos en la base de datos.</p>';
                return;
            }

            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.classList.add('product-item');
                productItem.innerHTML = `
                    <h3>${product.nombre} (ID: ${product.id})</h3>
                    <p>Precio: S/${product.precio.toFixed(2)} ${product.enOferta ? `(Oferta: S/${product.precioOriginal ? product.precioOriginal.toFixed(2) : ''} -${product.descuento || 0}%)` : ''}</p>
                    <p>Stock: ${product.stock}</p>
                    <p>Categoría: ${product.categoria || 'N/A'}</p>
                    <p>Destacado: ${product.destacado ? 'Sí' : 'No'}</p>
                    ${product.imagenes && product.imagenes.length > 0 ? `<img src="${product.imagenes[0]}" alt="${product.nombre}">` : ''}
                    <div class="actions">
                        <button class="edit-btn" data-id="${product.id}">Editar</button>
                        <button class="delete-btn" data-id="${product.id}">Eliminar</button>
                    </div>
                `;
                productListDiv.appendChild(productItem);
            });

            // Adjuntar event listeners para editar y eliminar
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => loadProductForEdit(e.target.dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteProduct(e.target.dataset.id));
            });
        }

        function loadProductForEdit(productId) {
            const productToEdit = productsData.find(p => p.id === productId);
            if (productToEdit) {
                productIdInput.value = productToEdit.id;
                productIdInput.readOnly = true; // No permitir cambiar el ID al editar
                productNameInput.value = productToEdit.nombre;
                productDescriptionInput.value = productToEdit.descripcion || '';
                productShortDescriptionInput.value = productToEdit.descripcionCorta || '';
                productPriceInput.value = productToEdit.precio;
                productOriginalPriceInput.value = productToEdit.precioOriginal || '';
                productDiscountInput.value = productToEdit.descuento || '';
                productImagesInput.value = (productToEdit.imagenes || []).join(', ');
                productStockInput.value = productToEdit.stock;
                productCategoryInput.value = productToEdit.categoria || '';
                productFeaturedInput.checked = productToEdit.destacado;
                productOnOfferInput.checked = productToEdit.enOferta;

                editingProductId = productId;
                saveProductBtn.textContent = 'Actualizar Producto';
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Subir al formulario
            }
        }

        function clearForm() {
            productForm.reset();
            productIdInput.readOnly = false;
            editingProductId = null;
            saveProductBtn.textContent = 'Guardar Producto';
            authError.style.display = 'none'; // Ocultar errores de autenticación si se limpian
        }

        // --- Event Listeners del Formulario ---

        productForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const productData = {
                id: productIdInput.value.trim(), // Elimina espacios en blanco
                nombre: productNameInput.value.trim(),
                descripcion: productDescriptionInput.value.trim(),
                descripcionCorta: productShortDescriptionInput.value.trim(),
                precio: parseFloat(productPriceInput.value),
                precioOriginal: productOriginalPriceInput.value ? parseFloat(productOriginalPriceInput.value) : null,
                descuento: productDiscountInput.value ? parseInt(productDiscountInput.value) : null,
                imagenes: productImagesInput.value.split(',').map(img => img.trim()).filter(img => img), // Array de strings
                stock: parseInt(productStockInput.value),
                categoria: productCategoryInput.value.trim(),
                destacado: productFeaturedInput.checked,
                enOferta: productOnOfferInput.checked,
            };

            // Validaciones adicionales del lado del cliente
            if (!productData.id) { alert('El ID del producto no puede estar vacío.'); return; }
            if (!productData.nombre) { alert('El nombre del producto no puede estar vacío.'); return; }
            if (isNaN(productData.precio)) { alert('El precio debe ser un número válido.'); return; }
            if (productData.precioOriginal && isNaN(productData.precioOriginal)) { alert('El precio original debe ser un número válido.'); return; }
            if (productData.descuento && isNaN(productData.descuento)) { alert('El descuento debe ser un número válido.'); return; }
            if (isNaN(productData.stock)) { alert('El stock debe ser un número válido.'); return; }


            if (editingProductId) {
                updateProduct(editingProductId, productData);
            } else {
                createProduct(productData);
            }
        });

        clearFormBtn.addEventListener('click', clearForm);

        // --- Lógica inicial (solo para el footer) ---
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>